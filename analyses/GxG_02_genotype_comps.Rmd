---
title: "Genotype x genotype interactions in host manipulation - Analyses"
author: "Dan Benesh"
output: github_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

# Experiment Background

Many parasites manipulate the behavior of their hosts in ways that seem beneficial. Little is known about genetic variation in this phenotype. Are parasites genetically variable in how much they manipulate host behavior? Do different host genotypes resist manipulation better than others? I infected 5 host strains with 5 parasite strains to quantify the variability in host manipulation due to parasite genes, host genes, and their interactions. The host-parasite system I used was the tapeworm *Schistocephalus solidus* in its copepod first intermediate host.

```{r importdata}
# import data - averaged within recordings
bd <- read.csv(file = "../data/behav_manutracked_reduced_dataset.csv", header = TRUE) # manual data
bdr <- read.csv(file = "../data/behav_autotracked_reduced_dataset.csv", header = TRUE) # auto-tracked data
infd <- read.csv(file = "../data/GxG_inf.csv", header = TRUE, fileEncoding = "UTF-8-BOM") #excel attached BOM to csv
```

```{r}
# take average worm size
infd <- mutate(infd, proc_size = (proc_size1 + proc_size2)/2)
```
```{r}
# add useful variables to manual data
bd <- mutate(bd, speed_per_sec = tot_dist/frames_tracked * 0.5,
       cop_name = substring(fname, 1, 5),
       day_char = substring(fname, 7, 8),
       plate_no = substring(fname, 1, 2),
       rec_time = factor(group, levels = c('before the drop', 'after the drop')))%>%
  select(-group)

# combine with inf data
bd <- left_join(bd, select(infd, -proc_size1, -proc_size2, -exposed, -tank, -cerc_multinom, -remarks),
                by = 'cop_name')
# better labels to trts
bd <- mutate(bd, trt = factor(trt, levels = c('unexposed', 'uninfected', 'infected')),
       trt = factor(trt, labels = c('unexposed, control', 'exposed, uninfected', 'infected')),
       parasite_fam = factor(parasite_fam, labels = c('A', 'B', 'C', 'D', 'E')),
       box = factor(box),
       devo_period = if_else(day_char %in% c("05", "07", "09"), "uninfective", 
                             if_else(day_char %in% c("11", "13", "15"), "partially infective", "infective")))%>%
  mutate(devo_period = factor(devo_period, levels = c("uninfective", "partially infective", "infective")))
```
```{r}
# add useful variables to auto data
bdr <- mutate(bdr, speed_per_sec = tot_dist/frames_tracked * 2,
       cop_name = substring(fname, 1, 5),
       day_char = substring(fname, 7, 8),
       plate_no = substring(fname, 1, 2),
       rec_time = factor(group, levels = c('before the drop', 'after the drop')))%>%
  select(-group)


# combine with inf data
bdr <- left_join(bdr, select(infd, -proc_size1, -proc_size2, -exposed, -tank, -cerc_multinom, -remarks),
                by = 'cop_name')
# better labels to trts
bdr <- mutate(bdr, trt = factor(trt, levels = c('unexposed', 'uninfected', 'infected')),
              trt = factor(trt, labels = c('unexposed, control', 'exposed, uninfected', 'infected')),
              parasite_fam = factor(parasite_fam, labels = c('A', 'B', 'C', 'D', 'E')),
              box = factor(box),
              devo_period = if_else(day_char %in% c("05", "07", "09"), "uninfective", 
                                    if_else(day_char %in% c("11", "13", "15"), "partially infective", "infective")))%>%
  mutate(devo_period = factor(devo_period, levels = c("uninfective", "partially infective", "infective")))
```

Copepod movement was video recorded for two minutes. After one minute, the well plate containing the copepods was dropped in a standardized way to simulate a predator attack and 'frighten' the copepods. Each copepod was recorded multiple times throughout the course of parasite development (from uninfective to infective larva).

I explored different behavioral variables that could be extracted from these recordings [here](GxG_01_define_responses.md). I decided to focus on 'activity', which was the average speed copepods moved before and after the drop (it could be equivalently expressed as the distance moved). Activity incorporates both the frequency and magnitude of copepod movements. And though I found that the difference between infected and uninfected copepods was mainly determined by [movement frequency](GxG_01_define_responses.md#proportion-of-time-moving-vs-hop-distance), I decided there was little to gain by breaking this variable down into its component parts.

In that [notebook](GxG_01_define_responses.md), the focus was on variation within the 2-minute recordings. There is another temporal scale in this experiment, behavior over the days of the parasite's development. Treatment differences also need to be considered at this level, because infected copepods may behave differently when harboring infective vs uninfective worms. However, before looking at treatment differences, the focus on behavior from one day to the next brings up the issue that some copepods died during the experiment. Should we filter these out? Or can we retain these data, because these copepods did not behave unusually before dying?

# Filter out dead copepods?

First of all, out of `r length(unique(bdr$cop_name))` total copepods with behavioral recordings, how many died during the experiment?

```{r}
x<-select(bdr, cop_name, dead)%>%distinct()
sum(x$dead)
```

That would be a fairly large number of copepods to exclude. Let's explore whether that is necessary. As a start, we can compare the behavior of copepods that died during the experiment with those that did not.

```{r}
bdr_avg <- filter(bdr, !is.na(speed_per_sec))%>%
  group_by(rec_time, dead, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

ggplot(bdr_avg, aes(x = as.numeric(day_char), y = speed_m, shape = factor(dead))) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 0.5)) +
  geom_line(aes(linetype = factor(dead))) +
  facet_grid(~rec_time) +
  labs(title = 'auto tracking', x = 'days post infection', y = 'average speed', shape = 'Dead', linetype = 'Dead')
```

The dead ones are less active on average, especially later on in the experiment, which seems realistic. However, treatment differences are lumped together in the above plot. Infecteds are less active than uninfecteds, and if they are also more likely to die, then that could drive the difference. However, the proportion of copepods that died was rather comparable across treatments.

```{r}
deads <- select(bdr, cop_name, trt, dead)%>%
  distinct()%>%
  mutate(dead = factor(dead, labels = c('survived', 'died')))%>%
  group_by(trt, dead)%>%
  summarize(n = n())%>%
  spread(dead, n)%>%
  mutate(prop_dead = died/(survived + died))
deads
```

Consequently, it is not surprising, that when we make the same plot, but separate the treatments, we get a similar pattern. The copepods that died exhibited somewhat lower activity levels, particularly later in the experiment.

```{r}
bdr_avg <- filter(bdr, !is.na(speed_per_sec))%>%
  group_by(rec_time, dead, trt, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

ggplot(bdr_avg, aes(x = as.numeric(day_char), y = speed_m, color = trt, shape = factor(dead))) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 0.5)) +
  geom_line(aes(linetype = factor(dead))) +
  facet_grid(trt~rec_time) +
  labs(title = 'auto tracking - 95% CI', color = 'Treatment', 
       x = 'days post infection', y = 'average speed', 
       linetype = 'Dead', shape = 'Dead')
```

Is this reason enough to toss data from dead copepods? Copepods died at different times during the experiment, so maybe their behavior only conspicuously changes right before death. Let's plot the behavioral profiles of individual copepods that died during the experiment. Activity across the experiment is shown for individual copepods (lines connect values for individuals). The vertical panels separate copepods by their time of death.

```{r}
ggplot(filter(bdr, dead == 1, days_surv != 9),
       aes(x = as.numeric(day_char), y = speed_per_sec)) + 
  geom_line(aes(group = cop_name), alpha = 0.2) +
  facet_grid(days_surv~rec_time) +
  scale_x_continuous(breaks = c(5,7,9,11,13,15,17,19,21)) +
  labs(title = 'auto tracking', x = 'days post infection', y = 'speed')
```

If copepods move less as they near death, then there should be an overabundance of downward lines on the right edge of the plots. That's not obvious, which is partly attributed to the substantial variation within individuals - activity measurements for a given copepod can differ quite a lot from day to day. Maybe the pattern emerges when we plot averages.

```{r}
# average values for dead
deads <- filter(bdr, dead==1, !is.na(speed_per_sec))%>%
  group_by(rec_time, days_surv, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

# average values for survivors
deads2 <- filter(bdr, dead==0)%>%
  group_by(rec_time, days_surv, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

# combine for plot
deads2 <- left_join(select(ungroup(deads), rec_time, day_char, days_surv), 
                    select(ungroup(deads2), -days_surv),
                    by = c('rec_time', 'day_char'))
deads2 <- filter(deads2, days_surv != 9)

ggplot(filter(deads, days_surv != 9),
       aes(x = as.numeric(day_char), y = speed_m)) +
  geom_point(color = 'red') +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                color = 'red', width = 0.5) +
  geom_line(color = 'red') +
  geom_point(data = deads2, aes(x = as.numeric(day_char), y = speed_m), color = 'gray') +
  geom_errorbar(data = deads2, aes(x = as.numeric(day_char), y = speed_m,
                                   ymin = lci, ymax = uci),
                color = 'gray', width = 0.5) +
  geom_line(data = deads2, aes(x = as.numeric(day_char), y = speed_m), color = 'gray') +
  facet_grid(days_surv~rec_time) +
  scale_x_continuous(breaks = c(5,7,9,11,13,15,17,19,21)) +
  labs(title = 'auto tracking - 95% CI',
       x = 'days post infection', y = 'average speed')
```

In the above plot, the average activity of copepods that died are red. I also plotted the values for copepods that did not die in gray for comparison. In some cases, copepod activity seems to drop as death approaches (for copepods that died on days 21, 20, 18), but not in others (days 16, 12, 10). Early in the experiment, when death is not imminent for most copepods, there is little difference between the dead and surviving copepods. Thus, my inclination is not to toss these data, as the differences seem minor, particularly because the 25 host-parasite genotype combinations cut the data relatively thin. Still, it also seems prudent to re-run the final analysis excluding these copepods to ensure that they do not bias the results.

# Treatment differences

Now let's compare the behavior of infected and uninfected copepods over the course of the experiment.

```{r}
bd_avg <- filter(bd, !is.na(speed_per_sec))%>%
  group_by(rec_time, trt, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

ggplot(bd_avg, aes(x = as.numeric(day_char), y = speed_m, color = trt)) +
  geom_point(position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 1)) +
  geom_line(position = position_dodge(width = 1)) +
  scale_x_continuous(breaks = c(5,7,9,11,13,15,17)) +
  facet_grid(~rec_time) +
  labs(title = 'manual tracking', color = 'Treatment', x = 'days post infection', y = 'average speed')
```
```{r}
bdr_avg <- filter(bdr, !is.na(speed_per_sec))%>%
  group_by(rec_time, trt, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

ggplot(bdr_avg, aes(x = as.numeric(day_char), y = speed_m, color = trt)) +
  geom_point(position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 1)) +
  geom_line(position = position_dodge(width = 1)) +
  facet_grid(~rec_time) +
  scale_x_continuous(breaks = c(5,7,9,11,13,15,17,19,21)) +
  labs(title = 'auto tracking', color = 'Treatment', x = 'days post infection', y = 'average speed')
```

Infected copepods are less active than uninfected copepods, regardless of days post infection. The worm becomes infective to its fish next host at around 11 days post infection. Other [studies](HAMMERSCHmidT) have found a conspicuous change in the behavior of infected copepods as worms develop from uninfective to infective larvae. Specifically they switch from reducing to increasing activity, relative to uninfecteds. However, this switch seems to be population-dependent, and it is not observed in the parasite population used in this experiment (see [here](HAFER)). In any case, the behavioral changes appear to affect copepods' predation susceptibility (see [here]()) and consequently parasite transmission and survival probabilities. Thus, the changes are likely to be fitness components under selection.

The response to the plate drop looks fairly consistent over time, though it is hard to gauge above. I plotted the change in activity in response to the drop below. The response seems rather consistent in the uninfected groups, while the infecteds seem to show less of a response to the drop towards the end of the experiment. However, this could also be because infecteds were slightly less active in general at the end of the experiment.

```{r}
ggplot(bdr_avg,
       aes(x = rec_time, y = speed_m, color = trt)) + 
  geom_line(aes(group = trt), position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 0.3)) +
  geom_point(position = position_dodge(width = 0.3)) +
  facet_wrap(~day_char, nrow = 3) +
  labs(title = 'Facetted by observation day', y = 'average speed', x = 'Drop', color = 'Treatment')
```

Our focus in this experiment is parasitic manipulation, i.e. how much infected copepods differ from uninfected copepods. But to look at genotype-by-genotype interactions we are restricted to using only infected copepods (uninfected copepods have no associated parasite genotype). So how should we define manipulation? I think there are two ways. First and simplest, we can take the raw behavior values for infected copepods, knowing that they differ from uninfecteds. Second and somewhat more complex, we can express infected copepod behavior relative to uninfected copepods, e.g. as a difference. In this first case, we assume that the absolute magnitude of behavior is most relevant for the parasite. In the second case, we consider manipulation in a relative sense in that some hosts at some times may be more or less susceptible to manipulation. We'll start with the simpler case - how do host and parasite genotypes affect infected copepod behavior?

# Manipulation in an absolute sense

Infected copepod activity differed among copepod genotypes, which were inbred families in this experiment.

```{r}
bdr_avg <- filter(bdr, trt == 'infected')%>%
  group_by(cop_fam)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))
relab <- as.character(arrange(bdr_avg, speed_m)$cop_fam)
bdr_avg <- mutate(bdr_avg, cop_fam = factor(cop_fam, levels = relab))

ggplot(bdr_avg, aes(x = cop_fam, y = speed_m)) +
  geom_errorbar(aes(ymin = lci, ymax = uci)) +
  geom_point() +
  labs(title = 'auto tracking - confidence intervals underestimated', x = 'host genotype', y = 'average speed')
```

Similarly, different parasite genotypes, full-sib families in this case, also exhibit different average activities. The overlap between parasite genotypes appears smaller than that between hosts, which implies that parasite genotype has a larger effect than host genotype.

```{r}
bdr_avg <- filter(bdr, trt == 'infected')%>%
  group_by(parasite_fam)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))
relab <- as.character(arrange(bdr_avg, speed_m)$parasite_fam)
bdr_avg <- mutate(bdr_avg, parasite_fam = factor(parasite_fam, levels = relab))

ggplot(bdr_avg, aes(x = parasite_fam, y = speed_m)) +
  geom_errorbar(aes(ymin = lci, ymax = uci)) +
  geom_point() +
  labs(title = 'auto tracking - confidence intervals underestimated', x = 'parasite genotype', y = 'average speed')
```

Now, we can plot host and parasite genotype simultaneously, i.e. their interaction.

```{r}
bdr_avg <- filter(bdr, trt == 'infected')%>%
  group_by(cop_fam, parasite_fam)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)),
         parasite_fam = factor(parasite_fam, levels = relab))

ggplot(bdr_avg, aes(x = parasite_fam, y = speed_m, color = cop_fam)) +
  geom_line(aes(group = cop_fam), position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 0.3)) +
  geom_point(position = position_dodge(width = 0.3)) +
  labs(title = 'auto tracking - confidence intervals underestimated', x = 'parasite genotype', 
       y = 'average speed', color = 'host genotype')
```

There appear to be both main effects (e.g. parasite genotype B is associated with lower host activity than genotype C) and interactions (e.g. some host genotypes show quite different behavior depending on the parasite genotype). Judging from these initial plots, it looks like parasite genotype has a clear effect, host genotype less so, and there are interactions. In the last three plots, I noted that confidence intervals were underestimated, and this is because I pooled together multiple observations from the same copepod across the experiment. 

If copepod behavior is temporally labile, then the effects of host and parasite genotype could change over the experiment. Here is how the activity of infected copepod genotypes varies over time. The relative rank of genotypes varies quite a lot. For example, genotype IV shows the lowest average activity on day 15 but the highest on day 21. It is also interesting that the between genotype-variation appears smaller initially than later in the experiment, i.e. the spread of the lines seems larger after 9 dpi.

```{r}
# cop fams
bdr_avg <- filter(bdr, trt == 'infected')%>%
  group_by(cop_fam, day_char)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))

ggplot(bdr_avg, aes(x = as.numeric(day_char), y = speed_m, color = cop_fam)) +
  geom_point(position = position_dodge(width = 0.75)) +
  geom_line(position = position_dodge(width = 0.75)) +
  scale_x_continuous(breaks = c(5,7,9,11,13,15,17,19,21)) +
  labs(title = 'auto tracking', color = 'Host genotype', x = 'days post infection', y = 'average speed')
```

It is also worth remembering that these are all infected copepods. We can also plot the behavior of uninfected copepods from the same families. It is not obvious that certain copepod genotypes are consistently more or less active, regardless of infection (i.e. the colors vary a lot in their relative position). 

```{r}
bdr_avg <- bdr%>%
  group_by(cop_fam, day_char, infected)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))

ggplot(bdr_avg, aes(x = as.numeric(day_char), y = speed_m, color = cop_fam, linetype = as.factor(infected))) +
  geom_point(position = position_dodge(width = 0.75)) +
  geom_line(position = position_dodge(width = 0.75)) +
  scale_x_continuous(breaks = c(5,7,9,11,13,15,17,19,21)) +
  labs(title = 'auto tracking', color = 'Host genotype', x = 'days post infection', y = 'average speed', linetype = "Infected")
```

From the previous plot, it is hard to tell if copepod genotypes react differently to infection. The next plot simply compares the average activity of infected and uninfected copepods from the 5 genotypes. The decrease in activity with infection is rather consistent, with perhaps the exception of one genotype (III).

```{r}
bdr_avg <- bdr%>%
  group_by(cop_fam, infected)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))

ggplot(bdr_avg, aes(x = as.factor(infected), y = speed_m, color = cop_fam)) +
  geom_point() +
  geom_line(aes(group = cop_fam)) +
  labs(title = 'auto tracking', color = 'Host genotype', x = 'Infected', y = 'average speed')

```

Differences among parasite genotypes appear a bit more consistent over time, which supports the idea that parasite genotype more strongly affects behavior than host genotype. However, the relative rank of different genotypes still change over time. Thus, in our modelling approach, we should also consider how genotype effects are time-dependent.

```{r}
# parasite fams
bdr_avg <- filter(bdr, trt == 'infected')%>%
  group_by(parasite_fam, day_char)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))

ggplot(bdr_avg, aes(x = as.numeric(day_char), y = speed_m, color = parasite_fam)) +
  geom_point(position = position_dodge(width = 1)) +
  geom_line(position = position_dodge(width = 1)) +
  scale_x_continuous(breaks = c(5,7,9,11,13,15,17,19,21)) +
  labs(title = 'auto tracking', color = 'Parasite genotype', x = 'days post infection', y = 'average speed')
```

### Models

As a model-building approach, I fit a series of increasingly complex models and then compare them to test specific hypotheses. The first model can be considered a 'null' or 'base' model - it includes variables that we are not specifically interested in, such as block of the experiment, days post infection, whether activity is before or after the drop, and individual copepod effects. The idea is to fit a model that accounts for uninteresting variation (with regard to our primary goals), and then to add host and parasite genotypes to the model to assess their importance. I start with linear mixed models (individual copepod as random effect), but acknowledge below that the distribution of the data (right-skewed with an overabundance of zeros) might call for more complex approaches.

I thought of three possible formulations for the base model. Fixed effects were reaction to the drop, day post infection, and experimental block, plus individual copepod as a random effect. Note that, philosophically, block could be considered a random effect, but there were only 3 blocks, so it has a small number of levels for a random effect. That was the simplest model, and then I allowed the copepod "drop reaction" to vary over time (days post infection) and by copepod (individuals can have different typical reactions).

```{r}
# start with linear mixed models, before experimenting with Tweedie
library(lme4)
# testing base models
lm0 <- lmer(speed_per_sec ~ box + rec_time + day_char + (1|cop_name), # no interactions
            data = filter(bdr, trt == 'infected'))
lm0.1 <- lmer(speed_per_sec ~ box + rec_time * day_char + (1|cop_name), # let reaction to drop depend on dpi
            data = filter(bdr, trt == 'infected'))
lm0.2 <- lmer(speed_per_sec ~ box + rec_time * day_char +
                (1|cop_name) + (rec_time|cop_name), # let reaction to drop vary by copepod - rand slopes
            data = filter(bdr, trt == 'infected'))
anova(lm0, lm0.1, lm0.2)
```

Letting the drop response vary by day post infection is an improvement. As we say above, the response to the drop tends to decrease later in the experiment, see [here](LINK). However, modelling copepod-specific responses did not improve the model. We can visualize this by taking a random sample of copepods and comparing how they responded to the drop. 

```{r}
rand_inf_cops <- sample( unique( filter(bdr, trt == 'infected')$cop_name ), size = 25)
bdr_avg <- filter(bdr, trt == 'infected', cop_name %in% rand_inf_cops)

ggplot(bdr_avg, aes(x = rec_time, y = speed_per_sec)) + 
  geom_line(aes(group = day_char)) + 
  facet_wrap(~cop_name, nrow = 5, ncol = 5) +
  scale_x_discrete(expand = c(0,0.5)) +
  labs(title = 'auto tracking, facetted by individual copepod', y = 'average speed') +
  theme(axis.title.x = element_blank())

```

Each panel in the plot above is an individual copepod, and we see that within panels there are quite a few crossing lines, indicating that individuals do not always respond to the drop in the same way across the multiple days of observation. However, there do appear to be some copepods that are consistently more or less active than others. In other words, there is variance due to individual differences, but there is not variance due to individual 'drop' responses.

So, let's take this as our base model: `speed_per_sec ~ box + rec_time * day_char + (1|cop_name)`
Next, we add the copepod and worm genotypes to the model as main effects (no interactions). Do they significantly improve the model?

```{r}
lm1 <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam + parasite_fam +
                (1|cop_name), # add cop and parasite fam
            data = filter(bdr, trt == 'infected'))
anova(lm0.1, lm1)
```

They do, suggesting that copepod activity is significantly affected by either host genotype, parasite genotype, or both. Parasite genotype seems to explain more variation than host genotype - its sum of squares is almost three times as large.

```{r}
anova(lm1)
```

Next, we add the interaction between host and parasite genotype, which was the primary interest of our experiment. It is significant as well, but only marginally, and it appears less explanatory than the main effects (i.e. it has a lower mean square).

```{r}
lm2 <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam +
                (1|cop_name), # add GxG interaction
            data = filter(bdr, trt == 'infected'))

anova(lm1, lm2) # interaction is sig
```

It is tempting to stop modelling here, because the results are relatively straightforward. However, I took two additional modelling steps. The first assesses whether copepod reaction to the drop is genotype-dependent. Specifically, I added a three-way interaction between host genotype, parasite genotype, and drop reaction. The goal is to see if genotype combinations respond to our artifical scare in different ways.

```{r}
lm3 <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam * rec_time +
                (1|cop_name), # let GxG combos react to drop differently
            data = filter(bdr, trt == 'infected'))
anova(lm2, lm3)
```

It is not significant, and we can confirm that by plotting how each genotype combo responds to the 'shock'. The average response is in red, overlaid on the individual reactions, and the average responses look quite comparable.

```{r}
bdr_avg <- group_by(bdr, rec_time, cop_fam, parasite_fam)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))%>%
  mutate(geno_comb = paste0(cop_fam,":",parasite_fam))

ggplot(bdr,
       aes(x = rec_time, y = speed_per_sec)) +
  geom_line(aes(group = fname), 
            alpha = 0.05, color = 'darkgray') +
  geom_line(data = bdr_avg,
            aes(group = geno_comb, x = rec_time, y = speed_m),
            color = 'red') +
  facet_grid(cop_fam ~ parasite_fam) +
  labs(y = 'speed') +
  theme(axis.title.x = element_blank())
```

In the next and final modelling step, we allow host-parasite interactions to vary across days of the experiment. In other words, the effects of host and parasite genotypes can vary from day to day. This consumes a huge number of degrees of freedom (5 host genotypes X 5 parasite genotypes x 9 observation days = 225 groups), and thus cuts the data somewhat thin. Instead of jumping to the full genotype x genotype x day interaction, we can use some biological knowledge to group the time periods of the experiment. Worms were uninfective from 5 to 9 dpi, developing infectivity from 11 to 15 dpi, and infective after 15 dpi. We can thus group the days according to worm development. We can check if letting genotype effects vary across these development groups improves the model. I take a stepwise approach, first letting either host genotype or parasite genotype vary with time, and then both.

Starting with copepod genotype, there is a significant interaction with experiment day. We saw this [above](). 

```{r}
lm4c <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam + cop_fam * devo_period +
                (1|cop_name), # let host genotype effects vary by day
            data = filter(bdr, trt == 'infected'))
lm4p <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam + parasite_fam * devo_period +
                (1|cop_name), # let parasite genotype effects vary by day
            data = filter(bdr, trt == 'infected'))
lm4g <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam +
               cop_fam * devo_period +
               parasite_fam * devo_period +
               cop_fam * parasite_fam * devo_period +
                (1|cop_name), # let GxG interactions vary by dp
            data = filter(bdr, trt == 'infected'))
```
```{r}
anova(lm2, lm4c)
```

The parasite genotype by day interaction was also significant. Interestingly, the magnitude of the effect was similar for host and parasite genotypes, at least judged by the chi square test statistic.

```{r}
anova(lm2, lm4p)
```

Finally, we allowed genotype-genotype interactions to vary over time. Despite the huge number of df this eats up, this model was a significant improvement over models with just a parasite genotype x day interaction or just a copepod genotype x day interaction.

```{r}
anova(lm4c, lm4g)
anova(lm4p, lm4g)
```

This suggests genotype effects are time-dependent. And in terms of the variance explained, the genotype by time interactions (the last 3 entries in the ANOVA table below) seem to have a comparable magnitude to the main effects of host and parasite genotype.

```{r}
anova(lm4g)
```

Here's an attempt to visualize these effects, starting with parasite genotype effects. Differences among parasite genotype look relatively consistent except for genotype C, which is especially active towards the end of the experiment.

```{r}
bdr_avg <- filter(bdr, trt == "infected")%>%
  group_by(devo_period, parasite_fam)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))

ggplot(bdr_avg, aes(x = devo_period, y = speed_m, color = parasite_fam)) +
  geom_line(aes(group = parasite_fam)) +
  labs(title = "Time-dependence of parasite genotype effects", x = 'worm development stage', color = 'parasite genotype', y = 'speed')
```

Though it doesn't come through in the stats, host genotype effects appear more variable (more line crossing). The variation attributable to host genotype also appears low at the beginning of the experiment compared to the end of the experiment.

```{r}
bdr_avg <- filter(bdr, trt == "infected")%>%
  group_by(devo_period, cop_fam)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))

ggplot(bdr_avg, aes(x = devo_period, y = speed_m, color = cop_fam)) +
  geom_line(aes(group = cop_fam)) +
  labs(title = "Time-dependence of host genotype effects", x = 'worm development stage', color = 'host genotype', y = 'speed')
```

Genotype by genotype interactions were also significant. This is challenging to visualize given the large number of combinations (25 genotype combos x 3 devo times = 75 groups!), but here's an attempt. Hopefully it shows that (i) host genotype effects are time dependent (within a panel there can be simultaneous peaks and dips for several parasite genotypes), that (ii) parasite genotype effects are time dependent (certain colors are not consistently high or low across time), and that host-parasite interactions vary over time (colors, vary in their position from panel to panel).

```{r}
bdr_avg <- filter(bdr, trt == "infected")%>%
  group_by(devo_period, cop_fam, parasite_fam)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))%>%
  mutate(geno_comb = paste0(cop_fam,":",parasite_fam, ":", devo_period))

ggplot(bdr_avg, aes(x = devo_period, y = speed_m, color = parasite_fam)) +
  geom_line(aes(group = parasite_fam)) +
  facet_wrap( ~ cop_fam, ncol = 1) +
  labs(title = 'host genotype', x = 'days post infection', color = 'parasite genotype', y = 'speed')
```

We should also make sure we are ignoring too much variation by just pooling the different days of the experiment according to worm developmental stage. Let's fit the same models, but allow genotype to vary by dpi instead of developmental period. This consumes a huge number of degrees of freedom, but in every comparison, allowing genotype effects to vary by day was an improvement over just allowing them to vary by developmental period.

```{r}
lm5c <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam + cop_fam * day_char +
                (1|cop_name), # let host genotype effects vary by day
            data = filter(bdr, trt == 'infected'))
lm5p <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam + parasite_fam * day_char +
                (1|cop_name), # let parasite genotype effects vary by day
            data = filter(bdr, trt == 'infected'))
lm5g <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam +
               cop_fam * day_char +
               parasite_fam * day_char +
               cop_fam * parasite_fam * day_char +
                (1|cop_name), # let GxG interactions vary by dp
            data = filter(bdr, trt == 'infected'))
```
```{r}
anova(lm4c, lm5c)
anova(lm4p, lm5p)
anova(lm4g, lm5g)
```

Since genotype x genotype interactions were time dependent, one additional twist to consider is whether responses to the drop were too. I added a 4-way interaction between host genotype, parasite genotype, day post infection, and drop response, but this did not further improve the model, which supports the idea that drop responses are relatively unaffected by genotype, even when accounting for their time-dependence.

```{r}
lm6 <- lmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam * day_char * rec_time +
                (1|cop_name), # let GxG interactions vary by dp
            data = filter(bdr, trt == 'infected'))
anova(lm5g, lm6)
```

So what did we learn from this modeling exercise? Both host genotype, parasite genotype, and their interaction affect copepod behavior. Additionally, these effects seem to vary over the course of the experiment, such that a genotype combination could be comparatively active on one day and relatively inactive the next. The response to our experimental scare tactic, the plate drop, seems time-dependent but not genotype-dependent. 

These were linear mixed models, assuming a Gaussian error distribution, but when we look at the residuals, it is clear they are not normally distributed. 

```{r}
plot(lm5g)
```

That is because our response variable, activity, has an overabundance of low (zero) values.

```{r}
ggplot(data = bdr, aes(x = speed_per_sec)) + geom_histogram(binwidth = 0.2)
```

This super [FAQ on generalized linear mixed models](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html) hints at two alternatives for this unusual distribution. First, fit hurdle models, in which a model is fit for zero/non-zero points and then fit a second model to the skewed non-zero data (e.g. inverse gamma). Second, fit a model that combines these distributions, i.e. a compound distribution like the Tweedie. 

Let's gives these more sophisticated models a go, and see if the results are the same. They are more computationally intense and take some time to fit.

## More sophisticated (generalized) models

First, we'll do a hurdle where we fit a generalized linear mixed model to whether copepods are moving or not.

```{r}
# make var for whether cops are moving or not
bdr <- mutate(bdr, moving = if_else(speed_per_sec > 0.1, 1, 0))
# first part of hurdle models - takes time!
h00 <- glmer(moving ~ box + rec_time * day_char + 
                (1|cop_name),
            data = filter(bdr, trt == 'infected'),
            family = binomial)
h01 <- glmer(moving ~ box + rec_time * day_char + cop_fam + parasite_fam +
                (1|cop_name),
            data = filter(bdr, trt == 'infected'),
            family = binomial)
h02 <- glmer(moving ~ box + rec_time * day_char + cop_fam * parasite_fam +
                (1|cop_name),
            data = filter(bdr, trt == 'infected'),
            family = binomial)
h03 <- glmer(moving ~ box + rec_time * day_char + cop_fam * parasite_fam * rec_time + 
                (1|cop_name),
            data = filter(bdr, trt == 'infected'),
            family = binomial)
# takes too long to fit
# h04 <- glmer(moving ~ box + rec_time * day_char + cop_fam * parasite_fam * day_char +
#                 (1|cop_name),
#             data = filter(bdr, trt == 'infected'),
#             family = binomial)
anova(h00, h01, h02, h03) # sig genotype main effects, but not interaction
```

The model comparison shows that adding genotype main effects improves the model, but adding their interaction does not. The next step in the 'hurdle' is to fit a mixed model with gamma error dist to just the copepods with movements.

```{r}
# fit for non-zeros
h10 <- glmer(speed_per_sec ~ box + rec_time * day_char +
               (1|cop_name),
            data = filter(bdr, trt == 'infected', moving == 1),
            family = Gamma(link = 'inverse'))
h11 <- glmer(speed_per_sec ~ box + rec_time * day_char + cop_fam + parasite_fam +
               (1|cop_name),
            data = filter(bdr, trt == 'infected', moving == 1),
            family = Gamma(link = 'inverse'))
h12 <- glmer(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam +
               (1|cop_name),
            data = filter(bdr, trt == 'infected', moving == 1),
            family = Gamma(link = 'inverse'))
anova(h10, h11, h12) # sig genotype main effects, but not interaction
```

```{r}
plot(lm2)
plot(h12)
```

Again, the main effects appear quite important, but not the interaction. The hurdle treats the two models as somewhat independent, but they are not - presumably zero values and low values are likely to occur at the same predictor values. A more integrated approach is to fit Compound Poisson Gamma models using the package `cplm`.

```{r}
library(cplm)

cpm0 <- cpglmm(speed_per_sec ~ box + rec_time * day_char +
                (1|cop_name), 
            data = filter(bdr, trt == 'infected'))
cpm1 <- cpglmm(speed_per_sec ~ box + rec_time * day_char + cop_fam + parasite_fam +
                (1|cop_name), 
            data = filter(bdr, trt == 'infected'))
cpm2 <- cpglmm(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam +
                (1|cop_name),
            data = filter(bdr, trt == 'infected'))
cpm3 <- cpglmm(speed_per_sec ~ box + rec_time * day_char + cop_fam * parasite_fam * day_char +
                (1|cop_name),
            data = filter(bdr, trt == 'infected'))
anova(cpm0, cpm1, cpm2, cpm3)
```

These complex models appear consistent with the hurdle models. There is an effect of genotype, but not an interaction. 

Show how these are better than linear models! Residual plot

```{r}
qplot(x = fitted(cpm3), y = resid(cpm3))
# resid plots for linear mixed model and for 
```
```{r}
qplot(x = fitted(lm5g), y = resid(lm5g))
```



# Manipulation in a relative sense - include uninfecteds in models

We can also quantify manipulation not in absolute terms, but relative to an expectation, namely the behavior of uninfected copepods. We had two groups of uninfected copepods: unexposed controls and exposed-but-uninfected copepods. Their behavior was very similar, which is consistent with other experiments.

```{r}
ggplot(filter(bdr, trt != "infected"), 
       aes(x = day_char, y = speed_per_sec, color = trt)) +
  geom_boxplot() +
  facet_wrap(~rec_time, ncol = 1) +
  labs(x = "days post infection", y = "speed")
```

Presumably, we can combine these two groups. Taking the base model defined earlier, we check if splitting the uninfected copepods into two groups improves the model. It does not, so we can combine them when calculating the typical behavior of uninfected copepods.

```{r}
lmu <- lmer(speed_per_sec ~ box + rec_time * day_char + (1|cop_name),
            data = filter(bdr, trt != 'infected', !is.na(trt)))
lmut <- lmer(speed_per_sec ~ box + rec_time * day_char + trt + (1|cop_name),
            data = filter(bdr, trt != 'infected', !is.na(trt)))
anova(lmu, lmut)
```

Some copepod genotypes may be more active than others, so a worm may have to 'manipulate' from different baselines. If parasites invest in manipulation the same, regardless of host background, then there should be a strong correlation between the behavior of copepod genotypes when infected and uninfected. We can plot this, and we can do so by splitting the data to different degrees. First, let's just average activity over the whole experiment for copepod genotypes when infected and uninfected.

```{r}
bdr_avgi <- filter(bdr, trt == "infected")%>%
  group_by(cop_fam)%>%
  summarize(speed_inf_mean = median(speed_per_sec, na.rm=T), n_inf = n())
bdr_avgu <- filter(bdr, trt != "infected")%>%
  group_by(cop_fam)%>%
  summarize(speed_uninf_mean = median(speed_per_sec, na.rm=T), n_uninf = n())

bdr_avg <- left_join(bdr_avgi, bdr_avgu)

ggplot(bdr_avg, aes(x = speed_uninf_mean, y = speed_inf_mean)) +
  geom_point() +
  labs(x = "Uninfected", y = "Infected")

```
```{r}
cor.test(bdr_avg$speed_inf_mean, bdr_avg$speed_uninf_mean, method = 'spearman')
```

There is a positive, non-significant correlation - one genotype in particular seems active regardless of infection status. Now, we split the data finer, averaging activity for each dpi for each genotype.

```{r}
bdr_avgi <- filter(bdr, trt == "infected")%>%
  group_by(day_char, cop_fam)%>%
  summarize(speed_inf_mean = median(speed_per_sec, na.rm=T), n_inf = n())
bdr_avgu <- filter(bdr, trt != "infected")%>%
  group_by(day_char, cop_fam)%>%
  summarize(speed_uninf_mean = median(speed_per_sec, na.rm=T), n_uninf = n())

bdr_avg <- left_join(bdr_avgi, bdr_avgu)

ggplot(bdr_avg, aes(x = speed_uninf_mean, y = speed_inf_mean)) +
  geom_point() + geom_smooth(se = F) +
  labs(x = "Uninfected", y = "Infected")
```
```{r}
cor.test(bdr_avg$speed_inf_mean, bdr_avg$speed_uninf_mean, method = 'spearman')
```

Again the correlation is positive, but not significant. Finally, split the data by dpi and recording period (before or after the drop).

```{r}
bdr_avgi <- filter(bdr, trt == "infected")%>%
  group_by(day_char, rec_time, cop_fam)%>%
  summarize(speed_inf_mean = median(speed_per_sec, na.rm=T), n_inf = n())
bdr_avgu <- filter(bdr, trt != "infected")%>%
  group_by(day_char, rec_time, cop_fam)%>%
  summarize(speed_uninf_mean = median(speed_per_sec, na.rm=T), n_uninf = n())

bdr_avg <- left_join(bdr_avgi, bdr_avgu)

ggplot(bdr_avg, aes(x = speed_uninf_mean, y = speed_inf_mean)) +
  geom_point() + geom_smooth(se = F) +
  labs(x = "Uninfected", y = "Infected")
```

```{r}
cor.test(bdr_avg$speed_inf_mean, bdr_avg$speed_uninf_mean, method = 'spearman')
```

The magnitude of the correlation is about the same, but it is now considered significant, due to the increase in df. These correlations suggest that there is a weak positive relationship between the behavior of copepod genotype when infected and uninfected. In other words, (in)active copepod genotypes tend to be (in)active when infected and uninfected, but there is quite a lot of variation around this relationship. Some is due to time - the difference between infected and uninfected copepods was not constant. But some may also be due to parasite genotypes - some manipulate more than others - or their interactions with host genotypes. Let's try a model-building approach that includes uninfected copepods.

```{r}
bdr <- mutate(bdr, infection = if_else(infected == 0, "uninfected", "infected"))%>% # make a nice variable for infection
  mutate(infection = factor(infection, levels = c("uninfected", "infected")))
```

We can start with the same base model that we used for just the infected copepods. It includes a copepod individual random effect, and the fixed effects of box, dpi, recording time, and the interaction between dpi and recording time. We then add infection, which is obviously highly significant. We can also add other terms to test how infection affects copepod behavior. Next, we add an interaction between infection and recording period (before or after the drop). It is also significant, because infected copepods respond less to the drop, probably because they are less active to begin with. Then, we let the difference between infected and uninfected copepods vary across the days of the experiment. This is also significant, because infected were more active, and thus more similar to uninfecteds, at the outset of the experiment. Finally, we let the response to the drop vary by day and infection. This term was not significant, suggesting the effect of infection on the drop response was constant across the 21 days of the experiment.

```{r}
lmu0 <- lmer(speed_per_sec ~ box + rec_time * day_char + (1|cop_name), # same base model as before - adding random slope for indiv cop reaction to drop
            data = bdr)
lmu1 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection + 
               (1|cop_name), # add infection
            data = bdr)
lmu1.1 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + 
               (1|cop_name), # infected respond differently to drop
            data = bdr)
lmu1.2 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               (1|cop_name), # infected vs uninfected differ by day of experiment
            data = bdr)
lmu1.3 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time * day_char + 
               (1|cop_name), # response to drop depends on infection and day
            data = bdr)
anova(lmu0, lmu1, lmu1.1, lmu1.2, lmu1.3)
```

Looking at raw effect sizes (sum sq), we can see that, of the infection effects, the main effect of infection is most important, followed by the infection x dpi interaction, and then the infection x recording period interaction.

```{r}
anova(lmu1.3)
```

Now, we have a model that includes the impact of infection. We want to see if additional variation is explained by host genotype. The main effect of copepod genotype is significant, indicating differences between our inbred lines. Interestingly, the effect of copepod genotype does not vary with infection - the infection x copepod genotype interaction was not significant. Genotypes also respond similarly to the drop.

```{r}
lmu2 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               cop_fam +
               (1|cop_name), # add cop fam main effect
            data = bdr)
lmu2.1 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam +
               (1|cop_name), # let cop fam effect depend on infection
            data = bdr)
lmu2.2 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * rec_time +
               (1|cop_name), # let drop response vary by infection and copepod genotype
            data = bdr)
anova(lmu1.2, lmu2, lmu2.1, lmu2.2)
```

Copepod genotypes that are active when uninfected are also relatively active when infected. The decrease in activity in response to the drop is also rather consistent across genotypes.

```{r}
bdr_avg <- group_by(bdr, cop_fam, infection, rec_time)%>%
  summarize(speed_inf_mean = median(speed_per_sec, na.rm=T), n_obs = n())

ggplot(bdr_avg, aes(x = infection, y = speed_inf_mean, color = cop_fam)) +
  geom_line(aes(group = cop_fam)) +
  geom_point(aes(size = n_obs)) +
  facet_wrap(~rec_time) +
  labs(x = "Infection", y = "Speed", color = "Copepod genotype")
```

Now, we want to add parasite genotype to the model. Even though copepod genotype effects did not depend on infection, we retain this interaction in the model, so that separate means are estimated for infected and uninfected copepods of each genotype, instead of having a mean that combines the behavior of uninfected and infected copepods. Unlike for copepod family, in which the levels are represented in both uninfected and infected copepods, the levels of parasite family are only relevant within the group of infected copepods. Thus, by adding parasite family to the model, we essentially split infected copepods by worm genotype to see if this explains additional variation. It does. And just like for host genotype, parasite genotype does not affect drop response.

```{r}
bdr <- mutate(bdr, parasite_fam2 = if_else(infected == 0, "uninfected", as.character(parasite_fam))) # re-formulate parasite family factor so all uninfecteds have same value
```
```{r}
lmu3 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam +
               parasite_fam2 +
               (1|cop_name), # add worm fam main effect
            data = bdr)
lmu3.1 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam +
               parasite_fam2 * rec_time+
               (1|cop_name), # let drop response depend on worm fam
            data = bdr)
anova(lmu2.1, lmu3, lmu3.1)
```

The next step is to examine the interaction between host and parasite genotype. It is not significant. Allowing genotype combinations to vary in their drop response was also not an improvement.

```{r}
lmu4 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               (1|cop_name), # add GxG effect
            data = bdr)
lmu4.1 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 * rec_time +
               (1|cop_name), # add GxG effect
            data = bdr)
anova(lmu3, lmu4, lmu4.1)
```

The analyses on just the infected copepods suggested that host and parasite effects, as well as their interaction, varied over the experiment. Let's add this time dependence, starting with using worm developmental period as the grouping variable. Allowing copepod genotype effects to vary over time was a significant improvement, as was splitting these effects by infection.

```{r}
lmu5c <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               cop_fam:devo_period +
               (1|cop_name), # let copepod genotype effects vary by day
            data = bdr)
lmu5c2 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               infection:cop_fam:devo_period +
               (1|cop_name), # let copepod genotype effects vary by infection and by day
            data = bdr)
lmu5p <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               parasite_fam2:devo_period +
               (1|cop_name), # let parasite genotype effects vary by day
            data = bdr)
lmu5g <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               infection:cop_fam:parasite_fam2:devo_period +
               (1|cop_name), # let GxG interactions vary by dp
            data = bdr)

anova(lmu4, lmu5c, lmu5c2)
```

Allowing parasite genotype effects to vary over time was also significant, though less so than for hosts.

```{r}
anova(lmu4, lmu5p)
```

Allowing time-dependent genotype by genotype effects was also an improvement over the two models with only time-dependent main effects.

```{r}
anova(lmu5p, lmu5g)
anova(lmu5c2, lmu5g)
```

When we fit the same models with dpi instead of worm developmental period, it is an improvement, regardless of whether copepod genotype, parasite genotype, or both were time dependent. Copepod behavior varies quite a lot from day to day among the genotypes.

```{r}
lmu6c <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               cop_fam:day_char +
               (1|cop_name), # let copepod genotype effects vary by day
            data = bdr)
lmu6c2 <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               infection:cop_fam:day_char +
               (1|cop_name), # let copepod genotype effects vary by infection and by day
            data = bdr)
lmu6p <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               parasite_fam2:day_char +
               (1|cop_name), # let parasite genotype effects vary by day
            data = bdr)
lmu6g <- lmer(speed_per_sec ~ box + rec_time * day_char + 
               infection * rec_time + infection * day_char + 
               infection * cop_fam * parasite_fam2 +
               infection:cop_fam:parasite_fam2:day_char +
               (1|cop_name), # let GxG interactions vary by dp
            data = bdr)
```

```{r}
anova(lmu5c, lmu6c)
anova(lmu5c2, lmu6c2)
anova(lmu5p, lmu6p)
anova(lmu5g, lmu6g)
```

In an absolute sense (sum of squares), these genotype x time interactions explain a lot of variation, which they should since they use so many df (224!). But in a relative sense (mean square), they are one of the least important terms in the model. My feeling is that this is an overparameterized model.

```{r}
anova(lmu6c)
```

But then when we plot the data, we can see how genotype effects are not temporally consistent. In this plot, each line is a genotype combination (so just copepod genotype for uninfected copepods; copepod x worm genotype combination for infecteds). The jumble of lines indicates that genotypes do not behave consistently throughout the experiment.

```{r}
bdr_avg <- bdr%>%
  group_by(day_char, infection, cop_fam, parasite_fam2)%>%
  summarize(speed_m = mean(speed_per_sec, na.rm=T))%>%
  mutate(geno_comb = paste0(infection, ":", cop_fam,":",parasite_fam2))

ggplot(bdr_avg, aes(x = day_char, y = speed_m, linetype = infection)) +
  geom_line(aes(group = geno_comb)) +
  labs(linetype = "Infection", x = 'days post infection', color = "copepod genotype", y = 'speed')

```

I am not quite sure how to interpret this. On the one hand, it might just be noise. Behavior varies from day to day, and this is not interesting or unexpected. On the other hand, it could have biological significance. Genotypes that manipulate strongly at one point in the experiment may not manipulate much at other times in the experiment.









# Variance partitioning (or comparing effect sizes)

# Correlated traits
GxG in infection, development, growth

Rerun excluding dead
Rerun basics with manual data