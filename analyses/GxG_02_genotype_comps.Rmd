---
title: "Genotype x genotype interactions in host manipulation - Analyses"
author: "Dan Benesh"
output: github_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

# Experiment Background

Many parasites manipulate the behavior of their hosts in ways that seem beneficial. Little is known about genetic variation in this phenotype. Are parasites genetically variable in how much they manipulate host behavior? Do different host genotypes resist manipulation better than others? I infected 5 host strains with 5 parasite strains to quantify the variability in host manipulation due to parasite genes, host genes, and their interactions. The host-parasite system I used was the tapeworm *Schistocephalus solidus* in its copepod first intermediate host.

```{r importdata}
# import data - averaged within recordings
bd <- read.csv(file = "../data/behav_manutracked_reduced_dataset.csv", header = TRUE) # manual data
bdr <- read.csv(file = "../data/behav_autotracked_reduced_dataset.csv", header = TRUE) # auto-tracked data
infd <- read.csv(file = "../data/GxG_inf.csv", header = TRUE, fileEncoding = "UTF-8-BOM") #excel attached BOM to csv
```

```{r}
# take average worm size
infd <- mutate(infd, proc_size = (proc_size1 + proc_size2)/2)
```

```{r}
# add useful variables to manual data
bd <- mutate(bd, speed_per_sec = tot_dist/frames_tracked * 0.5,
       cop_name = substring(fname, 1, 5),
       day_char = substring(fname, 7, 8),
       rec_time = factor(group, levels = c('before the drop', 'after the drop')))%>%
  select(-group)

# combine with inf data
bd <- left_join(bd, select(infd, -proc_size1, -proc_size2, -exposed, -tank, -cerc_multinom, -remarks),
                by = 'cop_name')
# better labels to trts
bd <- mutate(bd, trt = factor(trt, levels = c('unexposed', 'uninfected', 'infected')),
       trt = factor(trt, labels = c('unexposed, control', 'exposed, uninfected', 'infected')))
```
```{r}
# add useful variables to auto data
bdr <- mutate(bdr, speed_per_sec = tot_dist/frames_tracked * 2,
       cop_name = substring(fname, 1, 5),
       day_char = substring(fname, 7, 8),
       rec_time = factor(group, levels = c('before the drop', 'after the drop')))%>%
  select(-group)

# combine with inf data
bdr <- left_join(bdr, select(infd, -proc_size1, -proc_size2, -exposed, -tank, -cerc_multinom, -remarks),
                by = 'cop_name')
# better labels to trts
bdr <- mutate(bdr, trt = factor(trt, levels = c('unexposed', 'uninfected', 'infected')),
       trt = factor(trt, labels = c('unexposed, control', 'exposed, uninfected', 'infected')))
```

Copepod movement was video recorded for two minutes. After one minute, the well plate containing the copepods was dropped in a standardized way to simulate a predator attack and 'frighten' the copepods. Each copepod was recorded on several days throughout the course of parasite development (from uninfective to infective larva). 

I explored different aspects of behavior that could be quantifed from these recordings [here](GxG_01_define_responses.md). I decided to focus on 'activity', the average speed of copepod movement's before and after the drop, as this measure was simple and seemed to incorporate the differences between infected and uninfected copepods.

# Treatment differences

Infected copepods are less active than uninfected copepods, which presumably affects their susceptibility to predation. In the previous notebook, we look at treatment differences at the level of recordings. We did not examine how infected and uninfected copepods differ across the development period.

```{r}
bd_avg <- filter(bd, !is.na(speed_per_sec))%>%
  group_by(rec_time, trt, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

ggplot(bd_avg, aes(x = day_char, y = speed_m, color = trt)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 0.5)) +
  geom_line() +
  facet_grid(~rec_time) +
  labs(title = 'manual tracking', color = 'Treatment', x = 'days post infection', y = 'average speed')
```
```{r}
bdr_avg <- filter(bdr, !is.na(speed_per_sec))%>%
  group_by(rec_time, trt, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

ggplot(bdr_avg, aes(x = day_char, y = speed_m, color = trt)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 0.5)) +
  geom_line() +
  facet_grid(~rec_time) +
  labs(title = 'auto tracking', color = 'Treatment', x = 'days post infection', y = 'average speed')
```

Pre-infective versus post-infective
No difference between uninfected groups - consistent with previous analyses. Pool?

# Filter for survival

How many died during experiment?

```{r}
x<-select(bdr, cop_name, dead)%>%distinct()
sum(x$dead)
```
Out of `r length(unique(bdr$cop_name))` total copepods with behavioral recordings. Should we exclude these? 

Simple check
```{r}
bdr_avg <- filter(bdr, !is.na(speed_per_sec))%>%
  group_by(rec_time, dead, trt, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

bdr_avg
ggplot(bdr_avg, aes(x = day_char, y = speed_m, color = trt, shape = factor(dead))) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = lci, ymax = uci), 
                position = position_dodge(width = 0.5)) +
  facet_grid(trt~rec_time) +
  labs(title = 'auto tracking', color = 'Treatment', x = 'days post infection', y = 'average speed', shape = 'Dead')
```

Maybe a little lower, but when it is low samples and SEs are high.


Maybe their behavior just becomes conspicuous closer to death. Let's check.

```{r}
# make days before death var
bdr <- mutate(bdr, days_before_dead = if_else(dead == 1,
                                       as.numeric(day_char) - days_surv,
                                       NA_real_))
ggplot(bdr, aes(x = days_before_dead, y = speed_per_sec, color = trt)) + 
  geom_point(position = position_jitterdodge(), alpha = 0.5) + 
  geom_smooth(se=F) +
  facet_grid(~rec_time)
```

```{r}
ggplot(bdr, aes(x = days_before_dead, y = speed_per_sec, color = trt)) + 
  geom_line(aes(group = cop_name), alpha = 0.2) +
  facet_grid(~rec_time)
```

```{r}
ggplot(filter(bdr, dead == 1),
       aes(x = day_char, y = speed_per_sec)) + 
  geom_line(aes(group = cop_name), alpha = 0.2) +
  facet_grid(days_surv~rec_time) +
  geom_smooth(se=F, color = 'red')
```


```{r}
deads <- filter(bdr, dead==1, !is.na(speed_per_sec))%>%
  group_by(rec_time, days_surv, day_char)%>%
  summarize(speed_m = mean(speed_per_sec),
            speed_sd = sd(speed_per_sec),
            n = n())%>%
  mutate(uci = speed_m + 2 * (speed_sd/sqrt(n)),
         lci = speed_m - 2 * (speed_sd/sqrt(n)))

ggplot(deads, aes(x = day_char, y = speed_m)) + 
  geom_point() +
  geom_line() +
  facet_grid(days_surv~rec_time) 

```


# Manipulation in an absolute sense

# Manipulation in a relative sense

# Variance partitioning (or comparing effect sizes)

# Correlated traits
