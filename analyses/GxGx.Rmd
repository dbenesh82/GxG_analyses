---
title: "Genotype x genotype interactions in host manipulation"
author: "Dan Benesh"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(echo = FALSE)
options(stringsAsFactors = FALSE)
```

# Experiment Background
Many parasites manipulate the behavior of their hosts in ways that seem beneficial. Little is known about genetic variation in this phenotype. Are parasites genetically variable in how much they manipulate host behavior? Do different host genotypes resist manipulation better than others? I infected 5 host strains with 5 parasite strains to quantify the variability in host manipulation due to parasite genes, host genes, and their interactions. The host-parasite system I used was the tapeworm *Schistocephalus solidus* in its copepod first intermediate host.

```{r importdata}
# import data
bd <- read.csv(file = "../data/behav_combined_after_qc2.csv", header = TRUE) # manual data
bdr <- read.csv(file = "../data/behav_combined_auto_tracked_corrected.csv", header = TRUE) # auto-tracked data
infd <- read.csv(file = "../data/GxG_inf.csv", header = TRUE, fileEncoding = "UTF-8-BOM") #excel attached BOM to csv
```

Copepod movement was video recorded for two minutes. After one minute, the well plate containing the copepods was dropped in a standardized way to simulate a predator attack and 'frighten' the copepods. Each copepod was recorded on several days throughout the course of parasite development (from uninfective to infective larva). 

Recordings were both manually- (clicking on copepod position frame-by-frame) and automatically-processed (with a tracking program). The output from the two approaches was quite similar (see an extensive comparison [here](GITHUB LINK!!)). Each approach has some advantages and disadvantages. First of all, I identified mistakes in the manually-processed data, like incorrect number of frames, etc. (see [here](GITHUB LINK)); this human error motivated the development of an auto-tracker. The auto-tracker also allowed additional videos and copepods to be processed that were not included in the manual data for lack of time. However, the auto-tracker was also not free from mistakes, occassionally recording large movements that were not. Here I make sure that both datasets yield concordant results.

In this notebook, I first present descriptive statistics from the experiment. Then I look at ways of quantifying behavior and defining the response variable. I conduct exploratory analyses of the factors impacting the response variable. Finally, I fit models to test the hypothesis of genotype-by-genotype interactions.

```{r}
# Select and rename columns
bd <- select(bd, fname, cop_name, day, 
             slice = Slice.n., x = X, y = Y,
             dist = Distance, pixel = Pixel.Value, 
             ok_col_names, ok_col_num, ok_row_num)%>%
  arrange(day, cop_name, slice)

# for first observation of every video, no 'distance moved' can be calculated; replace with NA
bd$dist[bd$slice == 1 & bd$dist == -1] <- NA

# create new variables
bd <- mutate(bd, time_sec = slice * 2 - 4)
```

# Descriptive Statistics

Let's look at some basic stats. How many copepods were in the experiment?

```{r}
# correct problem from import with `cop_name` column
if(grepl(pattern = "?..", names(infd)[1])) { # if first column name has weird '?..' after import...
  names(infd)[1] <- 'cop_name' # change it
} 

# create new trt var with unexposed and uninfecteds pooled
infd$trt2 <- infd$trt
infd$trt2[which(infd$infected == 0)] <- 'uninfected'
```
```{r}
sum(!is.na(infd$exposed)) # if included, cops had a value for 'exposed' variable
```

How many were exposed to infection?

```{r}
sum(infd$exposed == 1, na.rm=T)
```

The rest were unexposed controls (n = `r sum( infd$exposed == 0, na.rm=T)`).

Whether copepods were infected or not was checked after a week. How many survived until being checked for infection?

```{r}
sum( !is.na(infd$infected) )
```

And how many were infected?

```{r}
sum(infd$infected == 1, na.rm=T)
```

So the infection rate was `r round(sum(infd$infected == 1, na.rm=T) / sum( infd$exposed == 1, na.rm=T), 3) * 100`%.

We can also do some quality control checks on our infection data. For example, I measured some parasite traits like cercomere presence (an indication of developmental rate) and worm size. So we can check to make sure these variables are only recorded from infected copepods, starting with cercomere presence. 

It is, though 5 infected copepods are missing cercomere data.
```{r}
table(!is.na(infd$cerc_d9), infd$trt)
```

Similarly, worm size was only recorded from infected copepods, though in 99 it was not measured. Most of those without size measurement died before the end of the experiment 21 days post exposure.

```{r}
table(!is.na(infd$proc_size1), infd$trt)
```

Worm size was measured twice. The two measures are highly correlated, with a pearson correlation coefficient of `r round( with(infd, cor(proc_size1, proc_size2, use = "pairwise")), 2)`, though there was some variation in the measurements.

```{r message=FALSE, warning=FALSE}
qplot(data = infd, x = proc_size1, y = proc_size2) + theme_bw()
```

Presumably, this is normal measurement error due to e.g. photo angles, moving worms, etc. The average of the two body size measurements is taken as the best measure of larval size in future analyses.

```{r}
infd <- mutate(infd, proca = (proc_size1 + proc_size2)/2) # average of 2 proc measurements
```

Moving on to the behavior data, how many copepods had their behavior recorded manually?

```{r}
bd_cops <- unique(bd$cop_name)
length(bd_cops)
```

How many were recorded automatically?

```{r}
bdr <- mutate(bdr, cop_name = substr(fname, 1, 5))
length(unique(bdr$cop_name))
```

There are 5 cop families and 5 parasite families. How many infected cops are in each group?

```{r}
# reduce infection table to just cops with behav measurements
infd_bd <- filter(infd, cop_name %in% bd_cops)

# make table
t <- with(filter(infd_bd, trt2 == 'infected'),
     table(cop_fam, parasite_fam))
t
```

It ranges from `r min(t)` to `r max(t)` per combination, with an average of `r mean(t)`. This is the same for both auto- and manually-tracked behavior data, as all infecteds but not all uninfecteds were tracked.

What about uninfecteds? Let's check the numbers of unexposed controls and exposed-but-uninfected copepods in each copepod family. Generally about 30 per family in the manually-tracked data.

```{r}
# make table
t <- with(filter(infd_bd, infected == 0),
     table(cop_fam, trt))
t
```

And for the auto-tracked data it was XXXX.
```{r}
# Auto tracked table of uninfecteds
```

# Define Response Variables

Behavior was recorded over two minutes, with the plate being dropped in the middle of the recording. So *a priori* we can divide a recording into three sections: before the drop, during the drop, and after the drop. The simplest behavioral measurement is the distance moved between frames. Let's see how the magnitude of movements changes throughout a recording.

```{r}
bdr_avg <- group_by(bdr, sec)%>%
  summarize(mean_dist = mean(distance, na.rm = T),
            mean_dp = mean(dot_product, na.rm = T))%>%
  mutate(group = if_else(sec < 58.5, 'before the drop', 
                         if_else(sec > 61.5, 'after the drop', 'drop')))

ggplot(bdr_avg, aes(x = sec, y = mean_dist)) + 
  geom_path() + geom_point(aes(color=group)) +
  scale_x_continuous(limits = c(0,120), breaks = seq(0, 120, by = 10)) +
  labs(title = 'auto tracker, 8 frames/s', color = 'section')
```
```{r warning=FALSE}
bd_avg <- group_by(bd, time_sec)%>%
  summarize(mean_dist = mean(dist, na.rm=T))%>%
  mutate(group = if_else(time_sec < 59, 'before the drop', 
                         if_else(time_sec > 62, 'after the drop', 'drop')))
  
ggplot(bd_avg, aes(x = time_sec, y = mean_dist)) + 
  geom_path() + geom_point(aes(color=group)) +
  scale_x_continuous(limits = c(0,120), breaks = seq(0, 120, by = 10)) +
  labs(title = 'manual tracker, 1 frame/2 s', color = 'section')
```

The most conspicuous pattern is the spike at 60 second during the drop. The copepod moves so fast during this drop that it cannot be tracked. The slight change in plate position through the drop also causes problems with background subtraction in the auto-tracking program. The values during the plate drop cannot be considered accurate and need to be removed before analyses. But how much should we remove on either side of the drop? 

Let's zoom in on the drop. It seems like taking the 1.5 seconds on either side of the drop seems to reasonably exclude most of the peak.

```{r}
ggplot(bdr_avg, aes(x = sec, y = mean_dist)) + 
  geom_path() + geom_point(aes(color=group)) +
  labs(title = 'auto tracker, 8 frames/s') + 
  scale_y_log10() + coord_cartesian(xlim = c(50, 70))
```

When we exclude the unreliable data around the 'drop', we see more clearly how copepods respond to the drop. 

```{r}
ggplot(filter(bdr_avg, group != 'drop'), 
       aes(x = sec, y = mean_dist, color = group)) + 
  geom_path() + 
  scale_x_continuous(limits = c(0,120), breaks = seq(0, 120, by = 10)) +
  labs(title = 'auto tracker, 8 frames/s')
```
```{r}
ggplot(filter(bd_avg, group != 'drop'), 
       aes(x = time_sec, y = mean_dist, color = group)) + 
  geom_path() + 
  scale_x_continuous(limits = c(0,120), breaks = seq(0, 120, by = 10)) +
  labs(title = 'manual tracking')
```

There is a clear decrease in activity directly after the drop, but the copepods seem to recover rather quickly such that by the end of the second minute their activity levels are back up to those before the drop. Also, in the auto-tracked data, there is still a spike shortly before the drop, which was not observed in the manual data. I think this represents a problem with how background subtraction worked at the 'edges' of the video (i.e. before and after the drop). Presumably, this is random error and it shouldn't bias treatment differences.

Another aspect of behavior that can be extracted from the recordings is the direction moved by copepods. I calculated the angle of movement between consecutive video frames.

```{r}
# calculate angle of movement for auto-tracked data
bdr <- mutate(bdr, x0 = lag(x), x2 = lead(x), y0 = lag(y), y2 = lead(y))%>%
    mutate(dist1 = sqrt((x0 - x)^2 + (y0 - y)^2) )%>%
    mutate(dist2 = sqrt((x - x2)^2 + (y - y2)^2) )%>%
    mutate(angle = acos(dot_product/(dist1 * dist2)) * 180/pi)%>%
    select(fname, frame, sec, x, y, blobs, blob_size, 
           distance, dot_product, angle)

# remove the angle calc for first observation in each recording
x <- group_by(bdr, fname)%>%
  summarize(frame_min = min(frame))%>%
  mutate(mv = paste(fname, frame_min))

bdr <- mutate(bdr, mv = paste(fname, frame))
bdr$angle[which(bdr$mv %in% x$mv)] <- NA
bdr <- select(bdr, -mv)
```

```{r}
# calculate angle of movement for manually-tracked data
bd <- mutate(bd, x0 = lag(x), x2 = lead(x), y0 = lag(y), y2 = lead(y))%>%
    mutate(dist1 = sqrt((x0 - x)^2 + (y0 - y)^2) )%>%
    mutate(dist2 = sqrt((x - x2)^2 + (y - y2)^2) )%>%
    mutate(dot_product = ((x2 - x) * (x - x0) + (y2 - y) * (y - y0)))%>%
    mutate(angle = acos(dot_product/(dist1 * dist2)) * 180/pi)%>%
    select(fname, day, slice, time_sec, x, y, 
           dist, dot_product, angle)

# remove the angle, dot_product calc for first observation in each recording
x <- group_by(bd, fname)%>%
  summarize(frame_min = min(slice))%>%
  mutate(mv = paste(fname, frame_min))
bd <- mutate(bd, mv = paste(fname, slice))
bd$angle[which(bd$mv %in% x$mv)] <- NA
bd$dot_product[which(bd$mv %in% x$mv)] <- NA
bd <- select(bd, -mv)
```

Here is the distribution of movement angles in both datasets.

```{r}
ggplot(bdr, aes(x = angle)) + geom_histogram(binwidth = 10) +
  labs(title = 'auto tracker')
```
```{r}
ggplot(bd, aes(x = angle)) + geom_histogram(binwidth = 10) +
  labs(title = 'manual tracking')
```

The distributions clearly differ; there are more forwards movements in the manual data and far more backwards movements in the auto data (angle values near 180). I think this is due to the time scales of the datasets. The auto-tracking data recorded copepod position 8 times per second, and consequently there was a lot of opportunity for slight oscillations of the tracker back and forth. By contrast, copepod position was recorded once every two seconds in the manual dataset, so there should be less 'noise' oscillations. 

Maybe we can understand the difference between the datasets by plotting angle vs the distance moved.

```{r}
bdr <- mutate(bdr, group = if_else(sec < 58, 'before the drop', 
                         if_else(sec > 62, 'after the drop', 'drop')))

ggplot(filter(bdr, sec<58|sec>62)%>%sample_n(100000), 
       aes(x = angle, y = distance, color = group)) + 
  geom_point(alpha = 0.01) +
  geom_smooth(se=F) +
  scale_y_continuous(limits = c(0, 30)) +
  labs(title = 'auto tracking')
```

```{r}
bd <- mutate(bd, group = if_else(time_sec < 59, 'before the drop', 
                         if_else(time_sec > 61, 'after the drop', 'drop')))
ggplot(filter(bd, group != 'drop'), aes(x = angle, y = dist, color = group)) +
  geom_point(alpha = 0.01) + geom_smooth(se=F) +
  labs(title = 'manual tracking')
```

Forward movements (low angles) tend to be larger in both datasets. But in the auto-tracked dataset, there is an overabundance of backward movements, some of which are large. This is the result of the auto-tracker incorrectly jumping to one part of the well and then back again. I took steps to eliminate these tracking mistakes (see [here](GITHUB)), but was perhaps too conservative in defining mistakes. There is no indication that the drop changed this aspect of copepod behavior - they move less, but when moving there is not a tendency to e.g. move backwards or in a zig-zag pattern.

We can plot how movement direction changes over a recording in both datasets.

```{r}
bdr_avg <- group_by(bdr, sec)%>%
  summarize(mean_dir = mean(angle, na.rm = T),
            var_dir = var(angle, na.rm = T))%>%
  mutate(group = if_else(sec < 58.5, 'before the drop', 
                         if_else(sec > 61.5, 'after the drop', 'drop')))

ggplot(bdr_avg, aes(x = sec, y = mean_dir)) + 
  geom_path() + geom_point(aes(color=group)) +
  scale_x_continuous(limits = c(0,120), breaks = seq(0, 120, by = 10)) +
  labs(title = 'angle - auto tracker')
```
```{r}
bd_avg <- group_by(bd, time_sec)%>%
  summarize(mean_dir = mean(angle, na.rm=T),
            var_dir = var(angle, na.rm=T))%>%
  mutate(group = if_else(time_sec < 59, 'before the drop', 
                         if_else(time_sec > 62, 'after the drop', 'drop')))

ggplot(bd_avg, aes(x = time_sec, y = mean_dir)) + 
  geom_path() + geom_point(aes(color=group)) +
  scale_x_continuous(limits = c(0,120), breaks = seq(0, 120, by = 10)) +
  labs(title = 'angle - manual tracker')
```

The difference in the mean angle of movement is obvious in the two datasets - the lower value in the manually-tracked data corresponds closely to the typical copepod movements along the edge of the circular well. The drop induces changes in opposite directions in the two datasets. The auto-tracker 'resets' at the drop (i.e. background subtraction of the video frames starts over), so it may not spot the copepod immediately. Once it is tracking something, the small back-and-forth oscillations then dominate and determine the mean values. In the manual dataset, the increase in angle values right after the drop could indicate more sideways or backwards movement by copepods, but this should not be over-interpreted because this was also where copepods moved the least. One consistent feature of both datasets: copepod movements return to 'pre-drop' values very quickly, suggesting the directions moved by copepods was not fundamentally altered by this shock.

Given that the auto-tracker introduces a lot of noise into this behavioral measure and that there is not an obvious effect of the drop, further evaluation of this variable may not be worthwhile. But before ignoring it, I want to check whether the angle of movements differs between infected and uninfected copepods.

```{r}
bdr <- mutate(bdr, cop_name = substring(fname, 1, 5))%>%
  mutate(dist_cat = cut(distance, breaks = c(0, 0.5, 2, 7)))

bd_i <- left_join(bdr, infd, by = 'cop_name')

ggplot(filter(bd_i, group != 'drop'),
       aes(y = angle, x = trt2)) +
  geom_boxplot() +
  labs(title = 'auto tracking - facetted by movement distance', x = 'treatment') +
  facet_grid(~dist_cat)
```

```{r}
bd <- mutate(bd, cop_name = substring(fname, 1, 5))%>%
  mutate(dist_cat = cut(dist, breaks = c(0, 0.5, 2, 7)))
bd_i <- left_join(bd, infd, by = 'cop_name')

ggplot(filter(bd_i, group != 'drop'),
       aes(y = angle, x = trt2)) +
  geom_boxplot() +
  labs(title = 'manual tracking - facetted by movement distance', x = 'treatment') +
  facet_grid(~dist_cat)
```

There is no conspicuous difference between treatments in either dataset, regardless of how large the movement values are. Another way to show this is to compare dot products among treatments, because the dot product combines information about the magnitude and direction of movements. [This plot](GITHUB) shows how the dot product does not differ among treatments. Thus, I will only consider the movement distance from this point forward.




# Exploratory Analyses

Make graph comparing treatments.

```{r message=FALSE, warning=FALSE}
bd_avg <- group_by(bd, time_sec, trt)%>%
  summarize(dista = mean(dist, na.rm=T))

ggplot(bd_avg, aes(x = time_sec, y = dista, color = trt)) +
  geom_line()
```

The infected copepods are less active than the uninfected copepods. This is true both before and after the simulated attack. When we separate this plot into the different days of the experiment, we see a similar pattern. Maybe at the earliest time point, day 5, the infected copepods are less manipulated.

```{r}
bd_avg <- group_by(bd, time_sec, day, trt)%>%
  summarize(dista = mean(dist, na.rm=T))

ggplot(bd_avg, aes(x = time_sec, y = dista, color = trt)) +
  geom_line() +
  facet_wrap(~day)
```

Now, let's look at the pattern for just the uninfected copepods, separated by copepod family. They seem pretty similar, thought one family (III) might be a little more active in general.

```{r}
bd_avg <- filter(bd, trt != 'infected')%>%
  group_by(time_sec, cop_fam)%>%
  summarize(dista = mean(dist, na.rm=T))

ggplot(bd_avg, aes(x = time_sec, y = dista, color = cop_fam)) +
  geom_line() 
```

Now, separate the data by parasite family. The differences appear reasonably consistent, suggesting parasite family is more important than host family.

```{r}
bd_avg <- filter(bd, trt == 'infected')%>%
  group_by(time_sec, parasite_fam)%>%
  summarize(dista = mean(dist, na.rm=T))

ggplot(bd_avg, aes(x = time_sec, y = dista, color = parasite_fam)) +
  geom_line() 
```

Here is the combo of host and parasite genotypes.

```{r}
bd_avg <- filter(bd, trt == 'infected')%>%
  group_by(cop_fam, parasite_fam)%>%
  summarize(dista = mean(dist, na.rm=T))

ggplot(bd_avg, aes(x = parasite_fam, y = dista, color = cop_fam)) +
  geom_line(aes(group = cop_fam))
```

# Models

```{r}
library(lme4)

# null model
out0 <- lmer(dist ~ factor(day) + (1|fname) + (1|cop_name), filter(bd, trt == 'infected'))

# add cop_fam to null
outc <- lmer(dist ~ cop_fam + factor(day) + (1|fname) + (1|cop_name), filter(bd, trt == 'infected'))
anova(out0, outc, test = 'Chi')

# add parasite_fam to null
outp <- lmer(dist ~ parasite_fam + factor(day) + (1|fname) + (1|cop_name), filter(bd, trt == 'infected'))
anova(out0, outp, test = 'Chi')

# add cop x parasite to null
outcp <- lmer(dist ~ cop_fam * parasite_fam + factor(day) + (1|fname) + (1|cop_name), filter(bd, trt == 'infected'))
anova(outc, outcp, test = 'Chi')
anova(outp, outcp, test = 'Chi')
```

GxG!!! Awesome!!


```{r}
sort(table(bd$dist), decreasing = T)
qplot(data = filter(bd, dist > 0), x = dist, binwidth = 0.1) 
#+ coord_cartesian(xlim = c(0, 0.5))
```

